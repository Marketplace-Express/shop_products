name: docker

on:
    push:
        # publish image as master=dev or on new tag
        # except on document and ci changes
        branches:
            - master
        tags:
            - '*'
        paths-ignore:
            - '**.md'
            - '.github/workflows/*yml'

    # always run tests on merge
    # except on document and ci changes
    pull_request:
        paths-ignore:
            - '**.md'
            - '.github/workflows/*yml'

env:
    ENV_FILE: .env
    MYSQL_ROOT_PASSWORD: root

jobs:
    unit_test:
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        services:
            mysql:
                image: "mysql:latest"
                env:
                    MYSQL_ALLOW_EMPTY_PASSWORD: yes
                    MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
                    MYSQL_USER: ${{ env.MYSQL_USER }}
                    MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
                ports:
                    - 3306:3306
                options: --health-cmd="mysql -e "SELECT 1;" --health-interval=10s --health-timeout=5s --health-retries=3

        steps:
            - name: Create docker network
              run: docker network create marketplace-network
            - name: Check out Site Repository ðŸ“„
              uses: actions/checkout@v2
            - name: Create .env file
              run: cp .env.example .env
            - name: Replace MySQL host
              run: sed -i 's/MYSQL_HOST.*/MYSQL_HOST=127.0.0.1/g' .env
            - name: Import environment variables from a file
              id: import-env
              shell: bash
              run: |
                while read line; do
                  echo "$line" >> $GITHUB_ENV
                  done < ${{ env.ENV_FILE }}
            - name: Running unit test
              run: docker-compose up products-unit-test